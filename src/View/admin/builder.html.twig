{% extends 'layout/base.html.twig' %}
{% block title %}Admin – Builder
{% endblock %}
{% block stylesheets %}
	<link rel="stylesheet" href="/assets/css//pages/builder.css">
{% endblock %}

{% block content %}
	<h1>Administration – Builder</h1>

	{% if errors is defined and errors %}
		<div class="alert error">
			<strong>Impossible d’enregistrer :</strong>
			<ul>
				{% for e in errors %}
					<li>{{ e }}</li>
				{% endfor %}
			</ul>
		</div>
	{% endif %}
	{% if flash %}
		<div class="flash-success">
			{{ flash }}
		</div>
	{% endif %}
	<form method="POST" action="/admin" id="builderForm" class="flow">
		<input type="hidden" name="csrf" value="{{ csrf }}"/>

		<div class="builder-toolbar">
			<button type="button" class="btn" onclick="addSection()">+ Ajouter une section</button>
			<button type="submit" class="btn btn-primary" style="background-color: green; border-style:none>💾 Sauvegarder</button>
			<button type="button" class="btn btn-cancel">
				<a href="/admin" target="_self">❌ Annuler</a>
			</button>

		</div>

		<div id="sectionsWrap" class="sections-wrap">
			{% for s in tree %}
				<details class="admin-section">
					<summary>
						<span class="section-title">Section</span>
						<input class="inline-input" name="sections[{{ s.id }}][nom]" value="{{ s.nom }}" placeholder="Nom" required>
						<input
						class="inline-input slug" name="sections[{{ s.id }}][slug]" value="{{ s.slug }}" placeholder="slug" required>
						{# 👇 Ordre d'affichage (section) #}
						<label class="stack mini">
							<span>Ordre</span>
							<input class="inline-input sm order-input" type="number" name="sections[{{ s.id }}][ordre_affichage]" value="{{ s.ordre_affichage }}" min="1" required>
						</label>
						<label class="check"><input type="checkbox" name="sections[{{ s.id }}][actif]" {{ s.actif ? 'checked' : '' }}>
							Actif</label>
						<label class="danger"><input type="checkbox" name="sections[{{ s.id }}][delete]">
							Supprimer</label>
					</summary>

					<div class="section-body">
						<label class="stack">
							<span>Description</span>
							<textarea name="sections[{{ s.id }}][description]" rows="2">{{ s.description }}</textarea>
						</label>

						<label class="stack">
							<span>Méta description</span>
							<input name="sections[{{ s.id }}][meta_description]" value="{{ s.meta_description }}">
						</label>

						<div class="section-actions">
							<button type="button" class="btn btn-soft" onclick="addPrestation('{{ s.id }}')">+ Ajouter une prestation</button>
						</div>

						<div class="prestations" id="prestations-{{ s.id }}">
							{% for p in s.prestations %}
								<details class="admin-prestation">
									<summary>
										<span class="presta-title">Prestation</span>
										<input type="hidden" name="prestations[{{ p.id }}][section_id]" value="{{ s.id }}">
										<input class="inline-input" name="prestations[{{ p.id }}][nom]" value="{{ p.nom }}" placeholder="Nom" required>
										<label class="stack mini">
											<span>Ordre</span>
											<input class="inline-input sm order-input" type="number" name="prestations[{{ p.id }}][ordre_affichage]" value="{{ p.ordre_affichage }}" min="1" required>
										</label>
										<label class="check"><input type="checkbox" name="prestations[{{ p.id }}][actif]" {{ p.actif ? 'checked' : '' }}>
											Actif</label>
										<label class="danger"><input type="checkbox" name="prestations[{{ p.id }}][delete]">
											Supprimer</label>
									</summary>

									<div class="presta-body">
										<label class="stack">
											<span>Description</span>
											<textarea name="prestations[{{ p.id }}][description]" rows="2">{{ p.description }}</textarea>
										</label>

										<div class="presta-actions">
											<button type="button" class="btn btn-soft" onclick="addTarif('{{ p.id }}')">+ Ajouter un tarif</button>
										</div>

										<div class="tarifs" id="tarifs-{{ p.id }}">
											{% for t in p.tarifs %}
												<div class="admin-tarif">
													<input type="hidden" name="tarifs[{{ t.id }}][prestation_id]" value="{{ p.id }}">
													<input class="inline-input sm" name="tarifs[{{ t.id }}][duree]" value="{{ t.duree }}" placeholder="Durée">
													<input class="inline-input sm" name="tarifs[{{ t.id }}][nb_seances]" value="{{ t.nb_seances }}" placeholder="Nb séances">
													<input class="inline-input sm" type="number" step="0.01" name="tarifs[{{ t.id }}][prix]" value="{{ t.prix }}" placeholder="Prix">
													<label class="stack mini">
														<span>Ordre</span>
														<input class="inline-input sm order-input" type="number" name="tarifs[{{ t.id }}][ordre_affichage]" value="{{ t.ordre_affichage }}" min="1" required>
													</label>
													<label class="danger"><input type="checkbox" name="tarifs[{{ t.id }}][delete]">
														Supprimer</label>
												</div>
											{% endfor %}
										</div>
									</div>
								</details>
							{% endfor %}
						</div>
					</div>
				</details>


			</div>

		{% else %}
			<p>Aucune section.</p>
		{% endfor %}
	</div>
	<div class="builder-toolbar">
		<button type="submit" class="btn btn-primary" style="background-color: green; border-style:none">💾 Sauvegarder</button>
		<button type="button" class="btn btn-cancel">
			<a href="/admin" target="_self">❌ Annuler</a>
		</button>
	</form>

{% endblock %}
{% block javascripts %}
	<script src="/assets/js/builder.js"></script>
{% endblock %}
